---
title: "Spatial distance"
author:
- name: Stephanie Hereira
  affiliation: Universidad Aut√≥noma de Tlaxcala
  email: sehereirap@uatx.mx
date: "`r format(Sys.time(), '%d - %m - %Y')`"
output:
  html_document:
    theme: flatly
    highlight: kate
    toc: yes
    toc_depth: 2
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---

## Figures 5
- Loading packages
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(RColorBrewer)
library(cowplot)
library(broom)
library(geosphere)
library(reshape2)
library(readxl)
library(qiime2R)

source("../Code/functions_betadiv.R")
```


Calculating distances between points

```{r, warning=FALSE, message=FALSE}
coords<- read_csv("../Data/coord.csv")

coords_mat<- coords%>% mutate(P=paste0("P",pol),
                              S=paste0("S", Sitio),
                              T=paste0("T", Transecto)) %>% unite("SampleID", 
  P:T, sep = "") %>% dplyr::select(
    SampleID, Longitude, Latitude) %>% column_to_rownames(
      var = "SampleID") %>% as.matrix() 


distance<- distm(coords_mat)/1000
colnames(distance)<- rownames(coords_mat)
rownames(distance)<- rownames(coords_mat)

distance_complete<- distance

distance[upper.tri(distance)] <- NA 

distance_dm<-melt(as.matrix(distance), varnames = c(
  "SampleID.x", "SampleID.y")) %>% drop_na() %>% filter(!value==0)



```

Loading data of fungi and metadata

```{r, warning=FALSE, message=FALSE}
map<- read.csv("../Data/coord.csv") %>% mutate_at(
    c(1,2,3,7), as.factor) %>% mutate(SampleID= paste0("P",pol, "S", Sitio,"T", Transecto ))
metadata<-read_excel("../Data/Metadatos.xlsx") %>% mutate_if(is.numeric, as.factor)
table_single_micop<- read.delim("../Data/table_micop_single.txt") 
table_paired_micop<- read.delim("../Data/table_micop_paired.txt")
table_qiime2<- data.frame(read_qza("../Data/clustered_table_filter.qza")$data, 
                          check.names = F) %>% t() %>% as.data.frame(
                                ) %>% rownames_to_column(
                            var = "SampleID") %>% separate(
                              SampleID, c(
                                "id_metagenome", "R", "unmap", "Paired"), 
                              sep = "_")%>% inner_join(
                                metadata) %>% dplyr::select(
                                -id_metagenome:-Paired, 
                                -id_sequence:-id_fisicoq, -Sites, 
                                -Names) %>% column_to_rownames(
                                  var="SampleID") %>% t(
                                  ) %>% as.data.frame() %>% mutate_all(as.numeric)

table_fungi<- read.delim("../Data/table_fungi_again.txt", 
                         skip = 1, row.names = 1, check.names = F) %>% dplyr::select_if( is.numeric)%>% t() %>% as.data.frame() %>% rownames_to_column(
                             var = "id_sequence") %>% separate(
                               ., "id_sequence", c("kraken", "fungi", "id_metagenome", "report", "bracken"),  sep = "_") %>% dplyr::select(-kraken, -fungi, -report, -bracken) %>% full_join( metadata) %>% dplyr::select(-id_sequence:-Transecto, -id_metagenome, -Sites, -id_new, -Names,  -id_fisicoq) %>% column_to_rownames( var = "SampleID") %>% t() %>% as.data.frame() %>% mutate_all(as.numeric)
```

Formatting data as lists and applying functions of beta diversity

```{r, warning=FALSE, message=FALSE}
otu <- list(table_qiime2, table_single_micop, table_paired_micop,  table_fungi)
otu_match<- lapply(otu, otu.match) # matching to map
otu_single<- lapply(otu_match, otu.single) #remove singletons
otu_norm<- lapply(otu_single, otu.norm)#Normalize
bc.dist<- lapply(otu_norm, beta_div_dist_bray)#Calculate Bray-Curtis dissimilarities 
bc.dist2<- lapply(otu_single, beta_div_dist_hill, q=1)#Calculate Horn dissimilarities 
bc.dist.tidy.filt<- lapply(bc.dist, bc.dist.tidy.filter)
bc.dist.tidy.filt2<- lapply(bc.dist2, bc.dist.tidy.filter.hill)

cor_test<- lapply(bc.dist.tidy.filt, cor.b)
lm_test<- lapply(bc.dist.tidy.filt, lm.b)

cor_test2<- lapply(bc.dist.tidy.filt2, cor.b)
lm_test2<- lapply(bc.dist.tidy.filt2, lm.b)

stats_qiime2 <- data.frame(
  label = paste0("Pearson: r = ",signif(cor_test[[1]]$estimate,3), 
                "p-value = ",   signif(cor_test[[1]]$p.value, 3),                                       "\nRegression: slope = ", signif(lm_test[[1]]$estimate, 3)))

stats_single <- data.frame(
  label = paste0("Pearson: r = ", signif(cor_test[[2]]$estimate,3), 
                 ", p-value = ", signif(cor_test[[2]]$p.value, 3),
                 "\nRegression: slope = ", signif(lm_test[[2]]$estimate, 3)))

stats_paired <- data.frame(
  label = paste0("Pearson: r = ", signif(cor_test[[3]]$estimate,3), 
                 ", p-value = ", signif(cor_test[[3]]$p.value, 3),
                 "\nRegression: slope = ", signif(lm_test[[3]]$estimate, 3)))

stats_kraken <- data.frame(
  label = paste0("Pearson: r = ", signif(cor_test[[4]]$estimate,3), 
                 ", p-value = ", signif(cor_test[[4]]$p.value, 3),
                 "\nRegression: slope = ", signif(lm_test[[4]]$estimate, 3)))


stats_qiime22 <- data.frame(
  label = paste0("Pearson: r = ",signif(cor_test2[[1]]$estimate,3), 
                "p-value = ",   signif(cor_test2[[1]]$p.value, 3),                                       "\nRegression: slope = ", signif(lm_test2[[1]]$estimate, 3)))

stats_single2 <- data.frame(
  label = paste0("Pearson: r = ", signif(cor_test2[[2]]$estimate,3), 
                 ", p-value = ", signif(cor_test2[[2]]$p.value, 3),
                 "\nRegression: slope = ", signif(lm_test2[[2]]$estimate, 3)))

stats_paired2 <- data.frame(
  label = paste0("Pearson: r = ", signif(cor_test2[[3]]$estimate,3), 
                 ", p-value = ", signif(cor_test2[[3]]$p.value, 3),
                 "\nRegression: slope = ", signif(lm_test2[[3]]$estimate, 3)))

stats_kraken2 <- data.frame(
  label = paste0("Pearson: r = ", signif(cor_test2[[4]]$estimate,3), 
                 ", p-value = ", signif(cor_test2[[4]]$p.value, 3),
                 "\nRegression: slope = ", signif(lm_test2[[4]]$estimate, 3)))
```


```{r, warning=FALSE, message=FALSE}
qiime2_data<- bc.dist.tidy.filt2[[1]] %>% mutate(Method="QIIME2")
single_data<- bc.dist.tidy.filt2[[2]] %>% mutate(Method="MICOP SINGLE")
paired_data<- bc.dist.tidy.filt2[[3]] %>% mutate(Method="MICOP PAIRED")
kraken_data<- bc.dist.tidy.filt2[[4]] %>% mutate(Method="KRAKEN2")

joined_data<- rbind(qiime2_data, single_data, paired_data, kraken_data )
joined_data$Method<- factor(joined_data$Method, levels = c(
  "QIIME2", "MICOP SINGLE", "MICOP PAIRED", "KRAKEN2"))


ann_text<-data.frame(val_distance=c( 30,30,30,30,
                                     4.2,4.2,4.2,4.2,
                                     4.2,4.2,4.2,4.2),
                     Similarity=c(0.8,0.3,0.3,0.3,
                                  0.8,0.3,0.3,0.3,
                                  0.8,0.3,0.3,0.3),
                     Distances=c("Spatial Distance (km)", 
                                 "Spatial Distance (km)", 
                                 "Spatial Distance (km)",
                                 "Spatial Distance (km)",
                                 "Environmental Distance", 
                                 "Environmental Distance", 
                                 "Environmental Distance",
                                 "Environmental Distance",
                                 "Vegetation Distance",
                                 "Vegetation Distance",
                                 "Vegetation Distance",
                                 "Vegetation Distance"),
                     Method=c("QIIME2", "MICOP SINGLE", "MICOP PAIRED", "KRAKEN2",
                              "QIIME2", "MICOP SINGLE", "MICOP PAIRED", "KRAKEN2",
                              "QIIME2", "MICOP SINGLE", "MICOP PAIRED", "KRAKEN2"),
                     label=c(stats_qiime2$label, 
                             stats_single$label, 
                             stats_paired$label, 
                             stats_kraken$label,
                             stats_qiime2_e$label, 
                             stats_single_e$label, 
                             stats_paired_e$label, 
                             stats_kraken_e$label,
                             stats_qiime2_v$label, 
                             stats_single_v$label, 
                             stats_paired_v$label, 
                             stats_kraken_v$label)) 

ann_text$Method<- factor(ann_text$Method, levels = c(
  "QIIME2", "MICOP SINGLE", "MICOP PAIRED", "KRAKEN2"))
ann_text$Distances<- factor(ann_text$Distances,
                            levels = c("Spatial Distance (km)", 
                                       "Environmental Distance", 
                                       "Vegetation Distance"))


jo<-joined_data %>% ggplot(aes(x = val_distance, y =Similarity ))+
  facet_grid(vars(Method), vars(Distances), scales = "free_x")+
  geom_point(shape = 16, size = 1, alpha = 0.5, color = "#566573") +
  geom_smooth(method = "lm", color = "black", se = F) +
  ylab("Horn similarity") +
  ylim(.2, max.sim) +
  theme_linedraw()+theme(legend.position = "none", 
                         axis.text = element_text(size = 12),
                         strip.text = element_text(size = 12, face = "bold.italic"),
                         panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                                         colour = "#E5E8E8"), 
                         panel.grid.minor = element_line(size = 0.25, linetype = 'solid',
                                                         colour = "#E5E8E8")) +  
  geom_text(data = ann_text,label=ann_text$label, size=3)+xlab("Distances")
jo
ggsave("Fig.Bray_joined_distances_all.png",width =8.7, height = 8.2, dpi = 300, plot = jo, device = "png")


```

